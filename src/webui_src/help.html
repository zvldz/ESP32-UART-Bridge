<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
    <title>ESP32 UART Bridge - Connection Help</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text x='50%' y='50%' font-size='12' text-anchor='middle' dominant-baseline='middle'>üîó</text></svg>">
    <link rel="stylesheet" href="/style.css">
    <style>
        .section {
            transition: padding 0.2s, margin 0.2s;
        }
        .section.collapsed {
            padding: 10px 15px;
            margin-bottom: 8px;
        }
        .section.collapsed h3 {
            margin: 0;
        }
        .collapsible-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .collapsible-header:hover {
            opacity: 0.8;
        }
        .collapse-arrow {
            font-size: 18px;
            transition: transform 0.2s;
        }
        .subsection {
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #007bff;
        }
        .subsection h4 {
            margin: 0 0 10px 0;
            cursor: pointer;
            user-select: none;
        }
        .subsection h4:hover {
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîó ESP32 UART Bridge - Connection Help</h1>

        <div class="section">
            <h3 class="collapsible-header" onclick="toggleSection('protocolContent', 'protocolArrow')">
                üì° Protocol Support
                <span id="protocolArrow" class="collapse-arrow">‚ñº</span>
            </h3>
            <div id="protocolContent">
                <div class="success">
                    <strong>Works with ANY UART protocol:</strong> DMA-accelerated with adaptive buffering (256-2048 bytes based on baud rate).
                </div>
                <p><strong>Optimized Protocols:</strong></p>
                <ul style="margin-left: 20px;">
                    <li><strong>SBUS</strong> - Multi-source failover, WiFi transport with UDP batching</li>
                    <li><strong>MAVLink</strong> - Zero-latency forwarding, multi-GCS routing, priority transmission</li>
                    <li><strong>Raw Mode</strong> - Timing-based packet detection for unknown protocols</li>
                </ul>
                <p><strong>Compatible with:</strong> SBUS (RC), MAVLink (drones), NMEA (GPS), Modbus RTU, AT Commands, and any UART-based protocol.</p>
            </div>
        </div>

        <div class="section">
            <h3 class="collapsible-header" onclick="toggleSection('wifiContent', 'wifiArrow')">
                üåê WiFi Operation Modes
                <span id="wifiArrow" class="collapse-arrow">‚ñº</span>
            </h3>
            <div id="wifiContent">
                <div class="success">
                    <strong>The bridge supports dual WiFi modes with flexible operation:</strong><br><br>
                    <strong>üì° WiFi Access Point (AP) Mode:</strong><br>
                    - Creates WiFi hotspot "ESP-Bridge-xxxx" with unique MAC suffix (password: 12345678)<br>
                    - Direct device configuration without existing WiFi<br>
                    - Access via 192.168.4.1 or mDNS (esp-bridge-xxxx.local)<br><br>
                    <strong>üîó WiFi Client Mode:</strong><br>
                    - Connects to existing WiFi networks (up to 5 with priority)<br>
                    - Remote access using assigned IP or mDNS hostname<br>
                    - Automatic fallback to next network on connection failure<br>
                    - <strong>Smart Connection:</strong> Scans every 15s, 5 password retries then tries next SSID (if configured)<br>
                    - Unlimited reconnection after successful initial connection<br><br>
                    <strong>Operation Duration:</strong><br>
                    - <strong>Temporary:</strong> Triple-click activation, 20-minute timeout<br>
                    - <strong>Permanent:</strong> Always-on via web checkbox, no timeout
                </div>
                <div class="warning">
                    <strong>üí° WiFi Mode Tips:</strong><br>
                    - <strong>LED Indicators:</strong> Purple (AP), Orange blink (Client searching), Orange solid (connected), Red blink (wrong password)<br>
                    - <strong>Triple-click logic:</strong> Standalone‚Üísaved mode, Client‚Üítemporary AP<br>
                    - <strong>Recovery:</strong> Hold BOOT 5s to reset (S3), or Factory Reset via web UI (MiniKit)<br>
                    - <strong>Remote access:</strong> Use permanent mode for always-on connectivity
                </div>
                <div class="success" style="margin-top: 15px;">
                    <strong>‚öôÔ∏è WiFi Advanced Settings:</strong><br><br>
                    <strong>üì∂ Multi-SSID (Client mode):</strong><br>
                    - Configure up to 5 WiFi networks with priority order<br>
                    - Device auto-connects to highest priority available network<br>
                    - Automatic fallback if current network becomes unavailable<br>
                    - Priority 1 = highest, Priority 5 = lowest<br><br>
                    <strong>üì° TX Power:</strong><br>
                    - Adjustable from 2dBm (minimum) to 20dBm (maximum)<br>
                    - Lower power reduces interference and power consumption<br>
                    - Higher power increases range but may cause instability<br>
                    - Default: 5dBm (Low) - good balance for most setups<br><br>
                    <strong>üìª AP Channel (AP mode only):</strong><br>
                    - Select WiFi channel 1-13 for Access Point mode<br>
                    - Use WiFi analyzer app to find least congested channel<br>
                    - Channels 1, 6, 11 are non-overlapping (recommended)<br>
                    - Default: Channel 1<br><br>
                    <strong>üì§ Auto Broadcast (Client + UDP TX modes):</strong><br>
                    - Automatically discovers UDP targets on the network<br>
                    - Sends broadcast packets to find listening clients<br>
                    - Useful when target IP is unknown or dynamic<br>
                    - Available only in Client mode with UDP TX/SBUS UDP TX roles
                </div>
            </div>
        </div>

        <div class="section">
            <h3 class="collapsible-header" onclick="toggleSection('usbContent', 'usbArrow')">
                üîå USB Modes
                <span id="usbArrow" class="collapse-arrow">‚ñº</span>
            </h3>
            <div id="usbContent">
                <div class="success">
                    <strong>The bridge supports two USB operation modes:</strong><br>
                    - <strong>Device Mode (default):</strong> ESP32 acts as USB-to-Serial converter, appears as COM port on PC<br>
                    - <strong>Host Mode:</strong> ESP32 acts as USB host for CDC devices (modems, GPS receivers, etc.)<br>
                    <br>
                    Configure USB mode in the main settings page. Requires restart after change.<br>
                    <br>
                    <em>Note: USB Host mode requires ESP32-S3-Zero or XIAO ESP32-S3. Not available on Super Mini or MiniKit.</em>
                </div>
                <div class="warning" style="background-color: #ffebee; border-left-color: #f44336;">
                    <strong>‚ö° Power Safety:</strong><br>
                    - <strong>Device Mode:</strong> Power via USB-C only<br>
                    - <strong>Host Mode:</strong> Power via external 5V pins only<br>
                    - <strong>Configuration Mode:</strong> Either power source works, but use ONLY ONE<br>
                    - <strong style="color: #d32f2f;">NEVER connect USB-C and external power at the same time!</strong><br>
                    <small>(Some boards have protection diodes allowing dual power, but verify your board's schematic first. Use at your own risk!)</small>
                </div>
            </div>
        </div>

        <div class="section">
            <h3 class="collapsible-header" onclick="toggleSection('pinsContent', 'pinsArrow')">
                üìå Pin Connections
                <span id="pinsArrow" class="collapse-arrow">‚ñº</span>
            </h3>
            <div id="pinsContent">
                <div class="warning" style="margin-bottom: 10px;">
                    <strong>üìå Board Support:</strong> Optimized for Waveshare ESP32-S3-Zero. Also supported: ESP32-S3 Super Mini (no USB Host, LED on GPIO48), XIAO ESP32-S3 (D-pin labels, single-color LED), ESP32 MiniKit with CP2104 (WROOM-32, no USB Host, Device 2 USB only, triple RESET for WiFi).
                </div>

                <!-- ESP32-S3-Zero / Super Mini subsection -->
                <div class="subsection">
                    <h4 onclick="toggleSection('zeroPinsContent', 'zeroPinsArrow')">
                        üîπ ESP32-S3-Zero / Super Mini
                        <span id="zeroPinsArrow" class="collapse-arrow" style="float: right;">‚ñº</span>
                    </h4>
                    <div id="zeroPinsContent">
                        <table>
                            <tr><th>ESP32-S3 Pin</th><th>Function</th><th>Connect To</th><th>Required</th></tr>
                            <tr><td colspan="4" style="background: #f0f4f8; font-weight: bold;">Device 1 - Main UART (Always Active)</td></tr>
                            <tr><td>GPIO4</td><td>UART RX</td><td>Device TX</td><td>‚úÖ Yes</td></tr>
                            <tr><td>GPIO5</td><td>UART TX</td><td>Device RX</td><td>‚úÖ Yes</td></tr>
                            <tr><td>GPIO6</td><td>RTS</td><td>Flow Control</td><td>‚ö™ Optional</td></tr>
                            <tr><td>GPIO7</td><td>CTS</td><td>Flow Control</td><td>‚ö™ Optional</td></tr>
                            <tr><td colspan="4" style="background: #f0f4f8; font-weight: bold;">Device 2 - Secondary UART (When UART2 Role Selected)</td></tr>
                            <tr><td>GPIO8</td><td>UART RX</td><td>Device TX</td><td>üìå If enabled</td></tr>
                            <tr><td>GPIO9</td><td>UART TX</td><td>Device RX</td><td>üìå If enabled</td></tr>
                            <tr><td colspan="4" style="background: #f0f4f8; font-weight: bold;">Device 3 - Mirror/Bridge/Logger</td></tr>
                            <tr><td>GPIO11</td><td>UART RX</td><td>Bridge mode only</td><td>üìå If bridge</td></tr>
                            <tr><td>GPIO12</td><td>UART TX</td><td>All Device 3 modes</td><td>üìå If enabled</td></tr>
                            <tr><td colspan="4" style="background: #f0f4f8; font-weight: bold;">Device 4 - Network Channel</td></tr>
                            <tr><td>Wi-Fi</td><td>Network</td><td>Logger/Bridge via UDP</td><td>üìå If enabled</td></tr>
                            <tr><td colspan="4" style="background: #f0f4f8; font-weight: bold;">System</td></tr>
                            <tr><td>GND</td><td>Ground</td><td>Device GND</td><td>‚úÖ Yes</td></tr>
                            <tr><td>GPIO0</td><td>BOOT Button</td><td>Built-in</td><td>‚úÖ Yes</td></tr>
                            <tr><td>GPIO21</td><td>RGB LED</td><td>Built-in (WS2812)</td><td>‚úÖ Yes</td></tr>
                        </table>
                    </div>
                </div>

                <!-- XIAO ESP32-S3 subsection -->
                <div class="subsection">
                    <h4 onclick="toggleSection('xiaoPinsContent', 'xiaoPinsArrow')">
                        üî∏ XIAO ESP32-S3
                        <span id="xiaoPinsArrow" class="collapse-arrow" style="float: right;">‚ñº</span>
                    </h4>
                    <div id="xiaoPinsContent">
                        <div class="warning" style="margin-bottom: 10px;">
                            <strong>üìå XIAO uses D-pin labels on board (castellated holes).</strong> Web interface shows both GPIO and D-pin numbers.
                        </div>
                        <table>
                            <tr><th>XIAO Pin</th><th>GPIO</th><th>Function</th><th>Connect To</th><th>Required</th></tr>
                            <tr><td colspan="5" style="background: #f0f4f8; font-weight: bold;">Device 1 - Main UART (Always Active)</td></tr>
                            <tr><td>D3</td><td>GPIO4</td><td>UART RX</td><td>Device TX</td><td>‚úÖ Yes</td></tr>
                            <tr><td>D4</td><td>GPIO5</td><td>UART TX</td><td>Device RX</td><td>‚úÖ Yes</td></tr>
                            <tr><td>D0</td><td>GPIO1</td><td>RTS</td><td>Flow Control</td><td>‚ö™ Optional</td></tr>
                            <tr><td>D1</td><td>GPIO2</td><td>CTS</td><td>Flow Control</td><td>‚ö™ Optional</td></tr>
                            <tr><td colspan="5" style="background: #f0f4f8; font-weight: bold;">Device 2 - Secondary UART (When UART2 Role Selected)</td></tr>
                            <tr><td>D8</td><td>GPIO8</td><td>UART RX</td><td>Device TX</td><td>üìå If enabled</td></tr>
                            <tr><td>D9</td><td>GPIO9</td><td>UART TX</td><td>Device RX</td><td>üìå If enabled</td></tr>
                            <tr><td colspan="5" style="background: #f0f4f8; font-weight: bold;">Device 3 - Mirror/Bridge/Logger</td></tr>
                            <tr><td>D7</td><td>GPIO44</td><td>UART RX</td><td>Bridge mode only</td><td>üìå If bridge</td></tr>
                            <tr><td>D6</td><td>GPIO43</td><td>UART TX</td><td>All Device 3 modes</td><td>üìå If enabled</td></tr>
                            <tr><td colspan="5" style="background: #f0f4f8; font-weight: bold;">Device 4 - Network Channel</td></tr>
                            <tr><td colspan="2">Wi-Fi</td><td>Network</td><td>Logger/Bridge via UDP</td><td>üìå If enabled</td></tr>
                            <tr><td colspan="5" style="background: #f0f4f8; font-weight: bold;">System</td></tr>
                            <tr><td>GND</td><td>-</td><td>Ground</td><td>Device GND</td><td>‚úÖ Yes</td></tr>
                            <tr><td>-</td><td>GPIO0</td><td>BOOT Button</td><td>Built-in</td><td>‚úÖ Yes</td></tr>
                            <tr><td>-</td><td>GPIO21</td><td>Single LED</td><td>Built-in (blink-only)</td><td>‚úÖ Yes</td></tr>
                        </table>
                    </div>
                </div>

                <!-- ESP32 MiniKit with CP2104 subsection -->
                <div class="subsection">
                    <h4 onclick="toggleSection('minikitPinsContent', 'minikitPinsArrow')">
                        üî∏ ESP32 MiniKit with CP2104 (WROOM-32)
                        <span id="minikitPinsArrow" class="collapse-arrow" style="float: right;">‚ñº</span>
                    </h4>
                    <div id="minikitPinsContent">
                        <div class="warning" style="margin-bottom: 10px;">
                            <strong>‚ö†Ô∏è MiniKit Requirements:</strong> Only boards with CP2104 USB-UART chip are supported (CH340/CH9102 not tested). No native USB, no PSRAM (~160KB heap), no UART2 option for Device 2 (GPIO8/9 used by flash). Device 2 is USB only. WiFi activation via triple RESET (no BOOT button).
                        </div>
                        <table>
                            <tr><th>GPIO Pin</th><th>Function</th><th>Connect To</th><th>Required</th></tr>
                            <tr><td colspan="4" style="background: #f0f4f8; font-weight: bold;">Device 1 - Main UART (UART1, Always Active)</td></tr>
                            <tr><td>GPIO4</td><td>UART RX</td><td>Device TX</td><td>‚úÖ Yes</td></tr>
                            <tr><td>GPIO5</td><td>UART TX</td><td>Device RX</td><td>‚úÖ Yes</td></tr>
                            <tr><td>GPIO18</td><td>RTS</td><td>Flow Control</td><td>‚ö™ Optional</td></tr>
                            <tr><td>GPIO19</td><td>CTS</td><td>Flow Control</td><td>‚ö™ Optional</td></tr>
                            <tr><td colspan="4" style="background: #ffebee; font-weight: bold;">Device 2 - NOT AVAILABLE (GPIO8/9 used by SPI flash)</td></tr>
                            <tr><td colspan="4" style="background: #f0f4f8; font-weight: bold;">Device 3 - Secondary UART (UART2)</td></tr>
                            <tr><td>GPIO16</td><td>UART RX</td><td>Bridge mode only</td><td>üìå If bridge</td></tr>
                            <tr><td>GPIO17</td><td>UART TX</td><td>All Device 3 modes</td><td>üìå If enabled</td></tr>
                            <tr><td colspan="4" style="background: #f0f4f8; font-weight: bold;">Device 4 - Network Channel</td></tr>
                            <tr><td>Wi-Fi</td><td>Network</td><td>Logger/Bridge via UDP</td><td>üìå If enabled</td></tr>
                            <tr><td colspan="4" style="background: #f0f4f8; font-weight: bold;">System</td></tr>
                            <tr><td>GND</td><td>Ground</td><td>Device GND</td><td>‚úÖ Yes</td></tr>
                            <tr><td>RESET</td><td>Reset Button</td><td>Built-in (triple-press for WiFi)</td><td>‚úÖ Yes</td></tr>
                            <tr><td>GPIO2</td><td>LED</td><td>Built-in (single-color, blink-only)</td><td>‚úÖ Yes</td></tr>
                        </table>
                    </div>
                </div>

                <div class="warning" style="margin-top: 10px;">
                    <strong>üìå Note:</strong> Device 2, 3, and 4 are only active when their respective roles are enabled in the configuration.
                </div>

                <div class="success" style="margin-top: 15px;">
                    <strong>üåê Device 4 - Network Channel:</strong><br>
                    - <strong>Network Logger:</strong> Stream system logs via UDP (port 14560)<br>
                    - <strong>Network Bridge:</strong> Bidirectional UART‚ÜîUDP conversion (port 14550)<br>
                    - <strong>SBUS Output:</strong> Send SBUS frames over WiFi (binary format)<br>
                    - <strong>SBUS Text Output:</strong> Send SBUS as text format via UDP<br>
                    - <strong>SBUS Input:</strong> Receive SBUS from WiFi with failover<br>
                    - Configure target IP and port in main settings<br>
                    - Requires active Wi-Fi connection
                </div>

                <div class="success" style="margin-top: 15px;">
                    <strong>üì∂ Device 5 - Bluetooth SPP (MiniKit only):</strong><br>
                    - <strong>Bridge:</strong> MAVLink/Raw telemetry to Android apps (QGC, Tower)<br>
                    - <strong>SBUS Text Output:</strong> Text format for Mission Planner RC Override plugin<br>
                    - Uses SSP "Just Works" pairing (no PIN required)<br>
                    - BT device name matches mDNS hostname<br>
                    - Available only on MiniKit (WROOM-32 has Bluetooth Classic)
                </div>
            </div>
        </div>

        <div class="section">
            <h3 class="collapsible-header" onclick="toggleSection('ledContent', 'ledArrow')">
                üí° LED Status Indicators
                <span id="ledArrow" class="collapse-arrow">‚ñº</span>
            </h3>
            <div id="ledContent">
                <div class="success">
                    <strong>Zero/SuperMini - RGB LED provides comprehensive visual feedback:</strong><br><br>
                    <strong>üìä Data Activity (Standalone Mode):</strong><br>
                    - <strong>Blue flashes</strong> - Data from device (UART RX)<br>
                    - <strong>Green flashes</strong> - Data from computer (USB RX)<br>
                    - <strong>Cyan flashes</strong> - Bidirectional data transfer<br><br>
                    <strong>üåê WiFi Network Status:</strong><br>
                    - <strong>Purple solid</strong> - WiFi AP mode active<br>
                    - <strong>Orange slow blink (2s)</strong> - WiFi Client searching<br>
                    - <strong>Orange solid</strong> - WiFi Client connected<br>
                    - <strong>Red fast blink (500ms)</strong> - WiFi Client error<br><br>
                    <strong>üîò System Status:</strong><br>
                    - <strong>White blinks</strong> - Button click feedback<br>
                    - <strong>Purple rapid blink</strong> - WiFi reset confirmation<br>
                    - <strong>Rainbow effect</strong> - Boot sequence (1 second)<br>
                    - <strong>Off</strong> - Idle, no data transfer
                </div>
                <table>
                    <tr><th>Context</th><th>LED State</th><th>Description</th></tr>
                    <tr><td>Data Activity</td><td>Blue/Green/Cyan flashes</td><td>50ms flash per data activity</td></tr>
                    <tr><td>WiFi AP Mode</td><td>Purple solid</td><td>Hotspot active</td></tr>
                    <tr><td>WiFi Client</td><td>Orange blink ‚Üí Orange solid</td><td>Searching ‚Üí Connected</td></tr>
                    <tr><td>WiFi Error</td><td>Red fast blink</td><td>Wrong password (5 attempts failed)</td></tr>
                    <tr><td>Button Feedback</td><td>White blinks</td><td>Shows click count</td></tr>
                </table>

                <div class="warning" style="margin-top: 15px;">
                    <strong>XIAO ESP32-S3 / MiniKit - Single-color LED (blink-only mode):</strong><br>
                    - <strong>Blinks</strong> indicate data activity (no color differentiation)<br>
                    - <strong>Three quick blinks</strong> - Boot sequence<br>
                    - <strong>Solid ON</strong> - WiFi AP mode active<br>
                    - <strong>Slow blink</strong> - WiFi Client searching<br>
                    - <strong>Fast blink</strong> - WiFi Client error<br>
                    - <strong>OFF</strong> - Idle, no data transfer
                </div>
            </div>
        </div>

        <div class="section">
            <h3 class="collapsible-header" onclick="toggleSection('guideContent', 'guideArrow')">
                üöÄ Basic Connection Guide
                <span id="guideArrow" class="collapse-arrow">‚ñº</span>
            </h3>
            <div id="guideContent">
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                    <h4>Minimal Setup - UART to USB Bridge</h4>
                    <p style="font-size: 18px; background: #e9ecef; padding: 10px; border-radius: 5px;">
                        <strong>Zero/SuperMini/MiniKit:</strong><br>
                        Device TX ‚Üí GPIO4, Device RX ‚Üí GPIO5, GND ‚Üí GND<br><br>
                        <strong>XIAO:</strong><br>
                        Device TX ‚Üí D3, Device RX ‚Üí D4, GND ‚Üí GND
                    </p>
                    <h4>Step 2: Connect USB</h4>
                    <p style="font-size: 18px; background: #d1ecf1; padding: 10px; border-radius: 5px;">
                        ESP32 USB-C ‚Üí Computer USB
                    </p>
                    <p><strong>Result:</strong> Transparent UART ‚Üî USB bridge ready!</p>
                    <p style="margin-top: 15px; font-size: 0.9em;"><em>For advanced configurations with Device 2/3, flow control, or USB Host mode, see the Pin Connections table above.</em></p>
                </div>
            </div>
        </div>

        <div class="section">
            <h3 class="collapsible-header" onclick="toggleSection('setupContent', 'setupArrow')">
                üõ†Ô∏è Setup Instructions
                <span id="setupArrow" class="collapse-arrow">‚ñº</span>
            </h3>
            <div id="setupContent">
                <div class="warning"><strong>‚ö†Ô∏è Important:</strong> Only connect signal wires and GND. Do not connect power between devices!</div>
                <div class="warning" style="background-color: #ffebee; border-left-color: #f44336;">
                    <strong>‚ö° Voltage Warning:</strong> ESP32-S3 GPIO pins support only 3.3V logic levels!<br>
                    Connecting 5V devices directly WILL damage the ESP32-S3.<br>
                    For 5V devices, you MUST use a level shifter (e.g., TXS0108E).
                </div>
                <ol>
                    <li><strong>Physical Connection:</strong> Connect TX‚ÜíGPIO4, RX‚ÜíGPIO5, GND‚ÜíGND</li>
                    <li><strong>Device Settings:</strong> Configure UART protocol and baud rate on your device</li>
                    <li><strong>Bridge Settings:</strong> Use this web interface to configure UART speed</li>
                    <li><strong>USB Mode:</strong> Select Device or Host mode based on your setup</li>
                    <li><strong>Network Mode:</strong> Choose temporary (triple-click) or permanent (web checkbox)</li>
                    <li><strong>USB Connection:</strong> Connect USB cable and select COM port in your application</li>
                </ol>
            </div>
        </div>

        <div class="section">
            <h3 class="collapsible-header" onclick="toggleSection('troubleContent', 'troubleArrow')">
                üîß Troubleshooting
                <span id="troubleArrow" class="collapse-arrow">‚ñº</span>
            </h3>
            <div id="troubleContent">
                <table>
                    <tr><th>Problem</th><th>Solution</th></tr>
                    <tr><td>No UART activity</td><td>Check TX/RX wiring, verify device UART settings</td></tr>
                    <tr><td>Application can't connect</td><td>Check USB connection, try different baud rate</td></tr>
                    <tr><td>LED not flashing</td><td>No data activity - check connections and device settings</td></tr>
                    <tr><td>Unstable connection</td><td>Enable Flow Control, check wire quality</td></tr>
                    <tr><td>No WiFi mode</td><td>Triple-click BOOT button (S3) or triple RESET (MiniKit), check LED</td></tr>
                    <tr><td>LED purple solid</td><td>WiFi AP mode active - connect to "ESP-Bridge-xxxx"</td></tr>
                    <tr><td>LED orange blinking</td><td>WiFi Client searching - check network availability</td></tr>
                    <tr><td>LED orange solid</td><td>WiFi Client connected - access via assigned IP</td></tr>
                    <tr><td>LED red blinking</td><td>WiFi Client error - wrong password (restart required)</td></tr>
                    <tr><td>Can't access WiFi Client</td><td>Triple-click BOOT (S3) for temp AP, or triple RESET (MiniKit, always AP)</td></tr>
                    <tr><td>WiFi takes long to connect</td><td>Normal - scans every 15s, tries 5x when network found</td></tr>
                    <tr><td>Forgot WiFi password</td><td>Hold BOOT 5s to reset (S3 only). MiniKit: use Factory Reset in web UI</td></tr>
                    <tr><td>Frequent crashes</td><td>Check Crash History on main page for patterns</td></tr>
                    <tr><td>Mission Planner reset loops</td><td>Enable "Disable RTS resets on ESP32 SerialUSB" in Mission Planner connection settings. ESP32-S3's native USB outputs bootloader messages that can confuse some applications.</td></tr>
                </table>
            </div>
        </div>

        <div class="section">
            <h3 class="collapsible-header" onclick="toggleSection('backupContent', 'backupArrow')">
                üíæ Configuration Backup & Restore
                <span id="backupArrow" class="collapse-arrow">‚ñº</span>
            </h3>
            <div id="backupContent">
                <div class="success">
                    <strong>Save and restore your device configuration:</strong><br>
                    <br>
                    <strong>üì§ Export Configuration:</strong><br>
                    - Click "Export Config" button on main page<br>
                    - Downloads JSON file with all current settings<br>
                    - Filename: [hostname]-config.json (e.g., esp-bridge-11fc-config.json)<br>
                    - Includes UART, WiFi, device roles, and logging settings<br>
                    <br>
                    <strong>üì• Import Configuration:</strong><br>
                    - Click "Import Config" button and select saved JSON file<br>
                    - Validates configuration structure and version<br>
                    - Applies all settings and automatically reboots device<br>
                    <br>
                    <strong>‚úÖ Use Cases:</strong><br>
                    - Quick setup of multiple identical devices<br>
                    - Backup configuration before firmware updates<br>
                    - Share working configurations between team members<br>
                    - Restore after device reset or configuration errors<br>
                    <br>
                    <strong>üîÑ Factory Reset:</strong><br>
                    - Click "Factory Reset" button to restore default settings<br>
                    - Erases all configuration (UART, WiFi, device roles)<br>
                    - Device reboots in AP mode with default settings<br>
                    - Use when configuration is corrupted or starting fresh
                </div>
            </div>
        </div>

        <div class="section">
            <h3 class="collapsible-header" onclick="toggleSection('buttonContent', 'buttonArrow')">
                üîò Button Functions
                <span id="buttonArrow" class="collapse-arrow">‚ñº</span>
            </h3>
            <div id="buttonContent">
                <div class="success">
                    <strong>BOOT Button (GPIO0) Functions - S3 Boards:</strong><br><br>
                    <strong>üîò Triple-Click (Mode Switching):</strong><br>
                    - <strong>From Standalone:</strong> Activates saved WiFi mode (Client or AP)<br>
                    - <strong>From WiFi Client:</strong> Forces temporary AP for reconfiguration<br>
                    - LED shows white blinks indicating click count<br>
                    - Useful when WiFi password changed or red LED error state<br><br>
                    <strong>üîÑ Long Press (5+ seconds):</strong><br>
                    - Resets WiFi settings to defaults (preserves UART and device roles)<br>
                    - SSID: "ESP-Bridge-xxxx" (unique), Password: "12345678"<br>
                    - LED flashes purple rapidly to confirm reset<br>
                    - Device automatically restarts<br><br>
                    <strong>‚ö° Power-On Hold:</strong><br>
                    - Hold during power-on for firmware update mode<br><br>
                    <strong>Mode Selection Summary:</strong><br>
                    - <strong>Temporary WiFi:</strong> Triple-click from any mode<br>
                    - <strong>Permanent WiFi:</strong> Enable checkbox in web interface<br>
                    - <strong>WiFi Recovery:</strong> Hold 5s to reset, then triple-click
                </div>
                <div class="warning" style="margin-top: 15px;">
                    <strong>RESET Button Functions - MiniKit (no BOOT button):</strong><br><br>
                    <strong>üîò Triple RESET (Temporary AP Mode):</strong><br>
                    - Press RESET button 3 times quickly (within 3 seconds each)<br>
                    - <strong>Always activates temporary AP mode</strong> (unlike S3 boards)<br>
                    - Guarantees access to Web UI regardless of saved WiFi settings<br><br>
                    <strong>‚ö†Ô∏è Notes:</strong><br>
                    - No WiFi reset via button (use Web UI Settings ‚Üí Factory Reset)<br>
                    - Counter resets if device runs >3 seconds between presses<br>
                    - Crashes do NOT count as resets (boot loop protection)
                </div>
            </div>
        </div>

        <div class="section">
            <h3 class="collapsible-header" onclick="toggleSection('crashContent', 'crashArrow')">
                üîç Crash Diagnostics
                <span id="crashArrow" class="collapse-arrow">‚ñº</span>
            </h3>
            <div id="crashContent">
                <div class="success">
                    <strong>The device automatically logs system crashes to help diagnose issues:</strong><br>
                    <br>
                    <strong>What is logged:</strong><br>
                    - Reset reason (PANIC, TASK_WDT, etc.)<br>
                    - Uptime before crash<br>
                    - Free heap memory<br>
                    - Minimum heap during session<br>
                    <br>
                    <strong>Viewing crash history:</strong><br>
                    1. Go to the main configuration page<br>
                    2. Look for "Crash History" section below System Logs<br>
                    3. Click to expand and view last 10 crashes<br>
                    4. Red badge shows total crash count<br>
                    <br>
                    <strong>Common crash patterns:</strong><br>
                    - Crashes at similar uptime ‚Üí Possible memory leak<br>
                    - Low heap values ‚Üí Out of memory<br>
                    - TASK_WDT ‚Üí Task blocked (often USB disconnect)<br>
                    - PANIC ‚Üí Software exception<br>
                </div>
            </div>
        </div>

        <p style="text-align: center; margin: 20px 0;">
            <strong>üìö Full documentation:</strong> <a href="https://github.com/zvldz/ESP32-UART-Bridge" target="_blank" style="color: #007bff;">https://github.com/zvldz/ESP32-UART-Bridge</a>
        </p>

        <div class="section" style="text-align: center;">
            <button onclick="window.close()">Close Help</button>
            <button onclick="location.href='/'">Back to Settings</button>
        </div>
    </div>

    <script>
        // Toggle section visibility with localStorage persistence
        function toggleSection(contentId, arrowId) {
            const content = document.getElementById(contentId);
            const arrow = document.getElementById(arrowId);
            if (!content) return;

            const isHidden = content.style.display === 'none';
            content.style.display = isHidden ? 'block' : 'none';
            if (arrow) arrow.textContent = isHidden ? '‚ñº' : '‚ñ∂';

            // Toggle collapsed class on parent section
            const section = content.parentElement;
            if (section && section.classList.contains('section')) {
                section.classList.toggle('collapsed', !isHidden);
            }

            // Save state to localStorage
            try {
                localStorage.setItem('help:' + contentId, isHidden ? 'shown' : 'hidden');
            } catch(e) {}
        }

        // Restore all section states on page load
        function restoreStates() {
            const sections = [
                'protocolContent', 'wifiContent', 'usbContent', 'pinsContent',
                'ledContent', 'guideContent', 'setupContent', 'troubleContent',
                'backupContent', 'buttonContent', 'crashContent',
                'zeroPinsContent', 'xiaoPinsContent', 'minikitPinsContent'
            ];

            sections.forEach(function(contentId) {
                const content = document.getElementById(contentId);
                const arrowId = contentId.replace('Content', 'Arrow');
                const arrow = document.getElementById(arrowId);
                if (!content) return;

                let state = null;
                try {
                    state = localStorage.getItem('help:' + contentId);
                } catch(e) {}

                // Default: all sections collapsed
                const defaultExpanded = false;
                const isExpanded = state === 'shown' || (state === null && defaultExpanded);

                content.style.display = isExpanded ? 'block' : 'none';
                if (arrow) arrow.textContent = isExpanded ? '‚ñº' : '‚ñ∂';

                // Set collapsed class on parent section
                const section = content.parentElement;
                if (section && section.classList.contains('section')) {
                    section.classList.toggle('collapsed', !isExpanded);
                }
            });
        }

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', restoreStates);
    </script>
</body>
</html>
