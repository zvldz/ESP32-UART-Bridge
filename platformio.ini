; PlatformIO Project Configuration File
[platformio]
description = ESP32 UART Bridge
name = esp32-uart-bridge
default_envs = zero_production  ; Default build environment

; ============================================
; BASE CONFIGURATION - shared by all environments
; ============================================
[env]
platform = https://github.com/pioarduino/platform-espressif32/releases/download/stable/platform-espressif32.zip
framework = arduino, espidf
board = esp32-s3-devkitm-1
; Disable IDF Component Manager completely
board_build.cmake_extra_args =
    -DIDF_COMPONENT_MANAGER=0

custom_component_remove = espressif/rmaker_common

board_build.embed_txtfiles =
  managed_components/espressif__esp_insights/server_certs/https_server.crt
  managed_components/espressif__esp_rainmaker/server_certs/rmaker_mqtt_server.crt
  managed_components/espressif__esp_rainmaker/server_certs/rmaker_claim_service_server.crt
  managed_components/espressif__esp_rainmaker/server_certs/rmaker_ota_server.crt

; Flash & Memory Configuration
board_build.flash_size = 4MB
board_upload.flash_size = 4MB
board_upload.maximum_size = 3276800
board_build.flash_mode = qio
board_build.psram_type = opi
board_build.memory_type = qio_opi
board_build.filesystem = littlefs
board_build.partitions = partitions_custom_4mb.csv

; Libraries
lib_deps =
    bblanchon/ArduinoJson@^7.4.2
    fastled/FastLED@^3.10.3
    arkhipenko/TaskScheduler@^4.0.3
    ;ESP32Async/ESPAsyncWebServer@^3.9.3 ; latest has issues(crashes)
    ;ESP32Async/AsyncTCP@^3.4.9
    ESP32Async/ESPAsyncWebServer@3.8.1
    ESP32Async/AsyncTCP@3.4.8

; Common Build Flags
build_flags =
    ; LittleFS
    -D CONFIG_LITTLEFS_SPIFFS_COMPAT=1
    ; USB
    -D ARDUINO_USB_CDC_ON_BOOT=1
    ; PSRAM
    -D BOARD_HAS_PSRAM
    ; System
    -D USE_UART_DMA=1
    -D CONFIG_ARDUINO_EVENT_RUNNING_CORE=1
    -D CONFIG_ESP32_EVENT_TASK_STACK_SIZE=4096
    ; TEST: Reduce AsyncTCP stack 16KB â†’ 8KB (saves ~8KB RAM)
    ; Note: 4KB caused stack overflow with WiFi+BLE coexistence
    -D CONFIG_ASYNC_TCP_STACK_SIZE=8192
    -Wno-deprecated-declarations
    -Wno-error=deprecated-declarations
    -Isrc/protocols
    -DMAVLINK_USE_CONVENIENCE_FUNCTIONS
    ; SBUS to MAVLink RC_OVERRIDE conversion (disabled by default to save memory)
    ; -D SBUS_MAVLINK_SUPPORT

; Upload & Monitor
monitor_speed = 115200
upload_speed = 921600

; Build scripts (shared by all environments)
extra_scripts =
    pre:scripts/embed_html.py
    pre:scripts/copy_sdkconfig.py
    pre:scripts/update_readme_version.py

; ============================================
; ESP32-S3-ZERO
; ============================================
[env:zero_production]
build_flags =
    ${env.build_flags}
    -D CORE_DEBUG_LEVEL=0
    -D BOARD_ESP32_S3_ZERO
    ;-D DEBUG  ; DO NOT DELETE - uncomment for forceSerialLog debugging
board_build.bootloader_log_level = none
monitor_filters = direct

[env:zero_debug]
build_flags =
    ${env.build_flags}
    -D CORE_DEBUG_LEVEL=2
    -D BOARD_ESP32_S3_ZERO
    ;-D DEBUG  ; DO NOT DELETE - uncomment for forceSerialLog debugging
lib_ignore = ESP_SR
board_build.bootloader_log_level = none
monitor_filters = esp32_exception_decoder, direct
build_type = debug

; ============================================
; ESP32-S3-ZERO WITH BLE
; ============================================
[env:zero_ble_production]
build_flags =
    ${env.build_flags}
    -D CORE_DEBUG_LEVEL=0
    -D BOARD_ESP32_S3_ZERO
    -D BLE_ENABLED
    '-DMODLOG_1(level, ...)='  ; Workaround for ESP-IDF NimBLE ble_svc_ras.c bug (disable RAS logging)
    ;-D DEBUG  ; DO NOT DELETE - uncomment for forceSerialLog debugging
; BLE uses ESP-IDF NimBLE component (configured in sdkconfig), no external lib needed
board_build.bootloader_log_level = none
monitor_filters = direct

[env:zero_ble_debug]
build_flags =
    ${env.build_flags}
    -D CORE_DEBUG_LEVEL=2
    -D BOARD_ESP32_S3_ZERO
    -D BLE_ENABLED
    '-DMODLOG_1(level, ...)='  ; Workaround for ESP-IDF NimBLE ble_svc_ras.c bug (disable RAS logging)
    ;-D DEBUG  ; DO NOT DELETE - uncomment for forceSerialLog debugging
; BLE uses ESP-IDF NimBLE component (configured in sdkconfig), no external lib needed
lib_ignore = ESP_SR
board_build.bootloader_log_level = none
monitor_filters = esp32_exception_decoder, direct
build_type = debug

; ============================================
; ESP32-S3-SUPER-MINI
; ============================================
[env:supermini_production]
extends = env:zero_production
build_flags =
    ${env:zero_production.build_flags}
    -UBOARD_ESP32_S3_ZERO
    -D BOARD_ESP32_S3_SUPER_MINI

[env:supermini_debug]
extends = env:zero_debug
build_flags =
    ${env:zero_debug.build_flags}
    -UBOARD_ESP32_S3_ZERO
    -D BOARD_ESP32_S3_SUPER_MINI

; ============================================
; ESP32-S3-SUPER-MINI WITH BLE
; ============================================
[env:supermini_ble_production]
extends = env:zero_ble_production
build_flags =
    ${env:zero_ble_production.build_flags}
    -UBOARD_ESP32_S3_ZERO
    -D BOARD_ESP32_S3_SUPER_MINI

[env:supermini_ble_debug]
extends = env:zero_ble_debug
build_flags =
    ${env:zero_ble_debug.build_flags}
    -UBOARD_ESP32_S3_ZERO
    -D BOARD_ESP32_S3_SUPER_MINI

; ============================================
; XIAO ESP32-S3
; ============================================
[env:xiao_production]
extends = env:zero_production
build_flags =
    ${env:zero_production.build_flags}
    -UBOARD_ESP32_S3_ZERO
    -D BOARD_XIAO_ESP32_S3

[env:xiao_debug]
extends = env:zero_debug
build_flags =
    ${env:zero_debug.build_flags}
    -UBOARD_ESP32_S3_ZERO
    -D BOARD_XIAO_ESP32_S3

; ============================================
; XIAO ESP32-S3 WITH BLE
; ============================================
[env:xiao_ble_production]
extends = env:zero_ble_production
build_flags =
    ${env:zero_ble_production.build_flags}
    -UBOARD_ESP32_S3_ZERO
    -D BOARD_XIAO_ESP32_S3

[env:xiao_ble_debug]
extends = env:zero_ble_debug
build_flags =
    ${env:zero_ble_debug.build_flags}
    -UBOARD_ESP32_S3_ZERO
    -D BOARD_XIAO_ESP32_S3

; ============================================
; ESP32 MINIKIT
; ============================================
[env:minikit_production]
board = esp32dev
build_flags =
    ${env.build_flags}
    -D CORE_DEBUG_LEVEL=0
    -D BOARD_MINIKIT_ESP32
    -D DEFAULT_PERMANENT_AP
    ;-D DEBUG  ; DO NOT DELETE - uncomment for forceSerialLog debugging
    -UBOARD_HAS_PSRAM
    -UARDUINO_USB_CDC_ON_BOOT
lib_ignore = ESP_SR
board_build.bootloader_log_level = none
monitor_filters = direct

[env:minikit_debug]
board = esp32dev
build_flags =
    ${env.build_flags}
    -D CORE_DEBUG_LEVEL=2
    -D BOARD_MINIKIT_ESP32
    -D DEFAULT_PERMANENT_AP
    ;-D DEBUG  ; DO NOT DELETE - uncomment for forceSerialLog debugging
    -UBOARD_HAS_PSRAM
    -UARDUINO_USB_CDC_ON_BOOT
lib_ignore = ESP_SR
monitor_filters = esp32_exception_decoder, direct
build_type = debug

; ============================================
; ESP32 MINIKIT WITH BLUETOOTH CLASSIC SPP
; ============================================
[env:minikit_bt_production]
board = esp32dev
build_flags =
    ${env.build_flags}
    -D CORE_DEBUG_LEVEL=0
    -D BOARD_MINIKIT_ESP32
    -D MINIKIT_BT_ENABLED
    -D DEFAULT_PERMANENT_AP
    ;-D DEBUG  ; DO NOT DELETE - uncomment for forceSerialLog debugging
    -UBOARD_HAS_PSRAM
    -UARDUINO_USB_CDC_ON_BOOT
lib_ignore = ESP_SR
board_build.bootloader_log_level = none
monitor_filters = direct

[env:minikit_bt_debug]
board = esp32dev
build_flags =
    ${env.build_flags}
    -D CORE_DEBUG_LEVEL=2
    -D BOARD_MINIKIT_ESP32
    -D MINIKIT_BT_ENABLED
    -D DEFAULT_PERMANENT_AP
    ;-D DEBUG  ; DO NOT DELETE - uncomment for forceSerialLog debugging
    -UBOARD_HAS_PSRAM
    -UARDUINO_USB_CDC_ON_BOOT
lib_ignore = ESP_SR
monitor_filters = esp32_exception_decoder, direct
build_type = debug

; ============================================
; ESP32 MINIKIT WITH BLE (NimBLE)
; ============================================
[env:minikit_ble_production]
board = esp32dev
build_flags =
    ${env.build_flags}
    -D CORE_DEBUG_LEVEL=0
    -D BOARD_MINIKIT_ESP32
    -D BLE_ENABLED
    -D DEFAULT_PERMANENT_AP
    '-DMODLOG_1(level, ...)='  ; Workaround for ESP-IDF NimBLE ble_svc_ras.c bug
    ;-D DEBUG  ; DO NOT DELETE - uncomment for forceSerialLog debugging
    -UBOARD_HAS_PSRAM
    -UARDUINO_USB_CDC_ON_BOOT
lib_ignore = ESP_SR
board_build.bootloader_log_level = none
monitor_filters = direct

[env:minikit_ble_debug]
board = esp32dev
build_flags =
    ${env.build_flags}
    -D CORE_DEBUG_LEVEL=2
    -D BOARD_MINIKIT_ESP32
    -D BLE_ENABLED
    -D DEFAULT_PERMANENT_AP
    '-DMODLOG_1(level, ...)='  ; Workaround for ESP-IDF NimBLE ble_svc_ras.c bug
    ;-D DEBUG  ; DO NOT DELETE - uncomment for forceSerialLog debugging
    -UBOARD_HAS_PSRAM
    -UARDUINO_USB_CDC_ON_BOOT
lib_ignore = ESP_SR
monitor_filters = esp32_exception_decoder, direct
build_type = debug
